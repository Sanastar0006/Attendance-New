<!doctype html>
<html lang="ta">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Staff Attendance</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{
  font-family: Arial;
  background:#f4f7fb;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}
.card{
  width:400px;
  background:#fff;
  padding:24px;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.1);
  text-align:center;
  position:relative;
}
#addUserBtn{
  position:absolute;
  right:15px;
  top:15px;
  background:#28a745;
  color:#fff;
  border:none;
  padding:6px 12px;
  font-size:13px;
  border-radius:6px;
  cursor:pointer;
}
.input-group{ position:relative;margin-bottom:16px; }
.input-group input{
  width:100%;padding:10px 36px;
  border-radius:6px;border:1px solid #cfd8e3;
  font-size:15px;
}
button{
  width:100%;background:#007bff;color:#fff;border:none;
  padding:10px;font-size:16px;border-radius:6px;cursor:pointer;
}
button:hover{ background:#0056b3; }
#attSection{ display:none;text-align:center; }
video{ width:320px;height:240px;background:#000;margin:10px auto;display:block; }
.row{ display:flex;justify-content:center;gap:10px;margin-top:10px; }
.row button{ width:auto;padding:8px 14px; }

/* Modal */
#userModal{
  position:fixed;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);display:none;
  align-items:center;justify-content:center;
}
.modal-box{
  background:#fff;padding:20px;width:90%;max-width:420px;
  border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.2);
}
.modal-box h3{ text-align:center;margin-top:0; }
.modal-box input{ width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:6px; }
.modal-box .mrow{ display:flex;gap:10px; }
</style>
</head>

<body>
<div class="card">
<button id="addUserBtn">Add User</button>

<h2>Staff Attendance</h2>

<!-- LOGIN -->
<div id="loginSection">
  <div class="input-group">
    <input id="username" type="text" placeholder="Email">
  </div>

  <div class="input-group">
    <input id="password" type="password" placeholder="Password">
  </div>

  <button id="loginBtn">Login</button>
  <p id="loginMsg" style="color:red"></p>
</div>

<!-- ATTENDANCE -->
<div id="attSection">
  <div class="row">
    <strong id="staffName">—</strong> &nbsp;
    <span id="staffUser" style="color:#666"></span>
  </div>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" width="320" height="240" style="display:none"></canvas>

  <div>
    <select id="status">
      <option>Present</option>
      <option>Half Day</option>
      <option>Leave</option>
    </select>
    <input id="note" placeholder="Note (optional)">
  </div>

  <div class="row">
    <button id="captureBtn">Capture</button>
    <button id="markBtn">Mark</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <p id="locText">Location: detecting...</p>
  <p id="statusMsg"></p>
</div>
</div>

<!-- ADD USER MODAL -->
<div id="userModal">
  <div class="modal-box">
    <h3>Add New User</h3>

    <input id="newName" placeholder="Staff Name">
    <input id="newId" placeholder="Staff ID">
    <input id="newUser" placeholder="User Email">
    <input id="newPass" type="password" placeholder="Create Password">
    <input id="newPass2" type="password" placeholder="Confirm Password">

    <div class="row" style="margin-top:10px;">
      <button style="background:#28a745;width:100%;" id="saveUserBtn">Save</button>
      <button style="background:#dc3545;width:100%;" id="closeModalBtn">Close</button>
    </div>

    <p id="userMsg" style="color:red;"></p>
  </div>
</div>

<script>
// Original staff list
const defaultStaff = [
  { name:"V. Shanmuganathan Veerapandiyan", username:"sanmuga0006@gmail.com", password:"Jothi@123", staffId:"001" },
  { name:"S. Bhuvaneshwar", username:"sbhuvaneshwari536@gmail.com", password:"Jothi@123", staffId:"002" }
];

// Load saved users
function loadUsers(){
  return JSON.parse(localStorage.getItem("staffList")) || [];
}

// Save users
function saveUsers(list){
  localStorage.setItem("staffList", JSON.stringify(list));
}

// ADD USER — SAVE
document.getElementById("saveUserBtn").onclick = () => {
  let n=document.getElementById("newName").value.trim();
  let id=document.getElementById("newId").value.trim();
  let u=document.getElementById("newUser").value.trim();
  let p=document.getElementById("newPass").value.trim();
  let p2=document.getElementById("newPass2").value.trim();

  if(!n || !id || !u || !p){ 
    userMsg.textContent="Fill all fields"; return;
  }
  if(p !== p2){
    userMsg.textContent="Password mismatch"; return;
  }

  const users = loadUsers();
  users.push({name:n, staffId:id, username:u, password:p});
  saveUsers(users);

  alert("User Added Successfully!");
  document.getElementById("userModal").style.display="none";
};

// open/close modal
addUserBtn.onclick = ()=> userModal.style.display="flex";
closeModalBtn.onclick = ()=> userModal.style.display="none";

// Login
const loginBtn=document.getElementById("loginBtn");
loginBtn.onclick = () => {
  const u=username.value.trim();
  const p=password.value.trim();
  if(!u || !p){ loginMsg.textContent="Enter login details"; return; }

  const savedUsers = loadUsers();
  const finalUsers = [...defaultStaff, ...savedUsers];

  const found = finalUsers.find(s => s.username===u && s.password===p);

  if(!found){ loginMsg.textContent="Invalid Login"; return; }

  // Login success
  current = found;
  loginSection.style.display="none";
  attSection.style.display="block";

  staffName.textContent = found.name;
  staffUser.textContent = found.username;

  startCamera();
  detectLocation();
};

// Camera
let stream=null;
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:true });
    video.srcObject=stream;
  }catch(e){
    alert("Camera Error: "+e);
  }
}

// Logout
logoutBtn.onclick = ()=>{
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  attSection.style.display="none";
  loginSection.style.display="block";
};

// Capture Photo
captureBtn.onclick = ()=>{
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  alert("Photo Captured!");
};

// Location
function detectLocation(){
  navigator.geolocation.getCurrentPosition(pos=>{
    locText.textContent = "Lat: "+pos.coords.latitude.toFixed(5)+
                          " / Lng: "+pos.coords.longitude.toFixed(5);
  }, ()=> locText.textContent="Location Error");
}

// Send Attendance
markBtn.onclick = ()=>{
  let img = canvas.toDataURL();
  alert("Attendance Sent!\n(*Your Google Script Logic Comes Here*)");
};
</script>
</body>
</html>
